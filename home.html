<!DOCTYPE html>
<html lang = "en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="council-style.css">
    <title>Ilus Vale Council</title>
</head>
<body>
    <header>
        <div id = "logo">
            <h1 class="dancing">Ilus Vale</h1>
            <h2>City Council</h2>
        </div>
        <div id = "nav">
            <p>About</p>
            <p>Report Complaint</p>
            <p>Contact Us</p>
        </div>
        <div id = "login">
            <p>Login</p>
            <p>Sign up</p>
        </div>
        
    </header>
    
    <div class = "content">

        <div class = "floating">
            <h3>Life Redefined</h3>
            <h4>Live Better in <i>Paradise</i></h4>
        </div>
        
        <div class = "infoBlock">
            <h3>Life Redefined</h3>
            <h4>Get all your needs catered to with our all inclusive <i>LIFE</i> package</h4>
            <div class = "infoBlock_items">
                <p>Best chefs in the world</p>
                <p>Housing</p>
                <p>Transportation</p>
                <p>Activities</p>
                <p>Custom Requests</p>
            </div>
        </div>

        
        <div class = "infoBlock">
            <h3>How we do it</h3>
            <div class = "infoBlock_items">
                <p>The entire city is run by robot working underneath the city to see to your need and desire. 
                    Your request is their sole mission. With our revolutionary AI and automated
                    robot production and education system, no request is too big or or too difficult for them to fulfill
                </p>
            </div>
            
        </div>

        <div class = "infoBlock">
            <h3>Council Information</h3>
            <p><i>Login or Sign up for more options</i></p>
            <div class = "infoBlock_items">
                <button id = "makeComplaint">Report Complaint</button>
                <button id = "requestAccount">Request Account</button>
                <button id = "showMeetings">View Council Meetings</button>
                <button id = "makeMeetings">Create Meetings</button>
                <button id="showComplaints">Review Complaints</button>
                
            </div>
            <div id = "councilActionsArea">

            </div>
        </div>
    </div>

    <footer>
        <p>s</p>
        <p>t</p>
        <p>u</p>
        <p>f</p>
        <p>f</p>
    </footer>


    <div class = "popUp" id = "complaintForm">
        <form>
            <h1>Submit Complaint</h1>
            <label for="desc">Complaint Description</label>
            <textarea id="descInput" placeholder="Description" name="desc" required maxlength="200"></textarea>

            <button id = "submitComplaint" type="button">Submit</button>
            <button id = "closeComplaintForm" type="button">Close</button>
        </form>
    </div>

    <div class = "popUp" id = "requestForm">
        <form>
            <h1>Submit Request</h1>
            <input type="text">
            <label for="usr">Request</label>
            <select name="usr" id="usrSelect">
                <option>thing1</option>
                <option>thing2</option>
                <option>thing3</option>
            </select>

            <button id = "submitRequest" type="button">Submit</button>
            <button id = "closeRequestForm" type="button">Close</button>
        </form>
    </div>

    <div class = "popUp" id = "meetingForm">
        <form>
            <h1>Create New Meeting</h1>
            <label for="date">Pick Date</label>
            <input type="datetime-local" id="meetDateInput" name="date">

            <label for="addy">Address</label>
            <input type="text" placeholder="123 paradise blvd" id="addressInput" name="addy">

            <button id = "submitMeeting" type="button">Add Meeting</button>
            <button id = "closeMeetingForm" type="button">Close</button>
        </form>
    </div>

</body>

<script>
    const baseUrl = "http://localhost:8080";

    const reportC = document.getElementById("makeComplaint");
    const cFormSubmit = document.getElementById("submitComplaint");
    const cFormClose = document.getElementById("closeComplaintForm");

    const reportR = document.getElementById("requestAccount");
    const rFormSubmit = document.getElementById("submitRequest");
    const rFormClose = document.getElementById("closeRequestForm");
    
    const reviewC = document.getElementById("showComplaints");
    const viewMeetings = document.getElementById("showMeetings");

    const makeMeeting = document.getElementById("makeMeetings");
    const mFormSubmit = document.getElementById("submitMeeting");
    const mFormClose = document.getElementById("closeMeetingForm");

    const actionsArea = document.getElementById("councilActionsArea");


    ////////////////// Report Complaint Pop-up  //////////////////
    reportC.addEventListener("click", function(event){
        document.getElementById("complaintForm").style.display = "flex";
    });
    cFormSubmit.addEventListener("click", async function(event){
        console.log(document.getElementById("descInput").value);
        const description = document.getElementById("descInput").value;
        let body = {cType: "COMPLAINT", description: description};

        const response = await fetch(baseUrl + "/complaints", {
            method: 'POST',
            body: JSON.stringify(body)
        });
        body = await response.json();
        document.getElementById("complaintForm").style.display = "none";
    });
    cFormClose.addEventListener("click", function(event){
        document.getElementById("complaintForm").style.display = "none";
    });

    ////////////////// Make Request Pop-up  //////////////////
    reportR.addEventListener("click", function(event){
        document.getElementById("requestForm").style.display = "flex";
    });
    rFormSubmit.addEventListener("click", async function(event){
        document.getElementById("requestForm").style.display = "none";
    });
    rFormClose.addEventListener("click", function(event){
        document.getElementById("requestForm").style.display = "none";
    });
    
    ////////////////// Create Meeting  //////////////////
    makeMeeting.addEventListener("click", function(event){
        document.getElementById("meetingForm").style.display = "flex";
    });
    mFormSubmit.addEventListener("click", async function(event){
        const date = document.getElementById("meetDateInput").value;
        const address = document.getElementById("addressInput").value;
        let epoch = new Date(date);
        epoch = epoch.getTime() / 1000;
        let body = {date: epoch, address: address};

        const response = await fetch(baseUrl + "/meetings", {
            method: 'POST',
            body: JSON.stringify(body)
        });
        body = await response.json();
    });
    mFormClose.addEventListener("click", function(event){
        document.getElementById("meetingForm").style.display = "none";
    });

    ////////////////// Complaint and meetings tables  //////////////////
    
    document.addEventListener("click", async function(event){
        const btn = event.target;
        if(btn.className === "editComplaint"){
            const id = btn.id;
            const priority = document.getElementById(`priority${id}`);
            const pVal = priority.options[priority.selectedIndex].value;
            const meetingId = document.getElementById(`meetingId${id}`);

            console.log(`Id: ${id}  priority: ${pVal} meeting: ${meetingId.value}`);
        
            const response = await fetch(baseUrl + `/complaints/${id}/setMeeting/${meetingId.value}`, {
                method: "PATCH"
            });
            if(pVal === "HIGH"){
                await fetch(baseUrl + `/complaints/${id}/setHigh`, {method: "PATCH"});
            }else if(pVal === "LOW"){
                await fetch(baseUrl + `/complaints/${id}/setLow`, {method: "PATCH"});
            }else if(pVal ==="IGNORED"){
                await fetch(baseUrl + `/complaints/${id}/setIgnored`, {method: "PATCH"});
            }
        }

        if(btn.id === "cSortAll" ){
            console.log("click");
            document.getElementById("cSortUnreviewed").checked = false;
            document.getElementById("cSortHigh").checked = false;
            document.getElementById("cSortLow").checked = false;

            const cardArea = document.getElementById("cardsArea");
            while(cardArea.firstChild){cardArea.removeChild(cardArea.firstChild)}

            const response = await fetch(baseUrl + `/complaints`, {method: "GET"});
            const body = await response.json();

            for(let b of body){
                const div = document.createElement("div");
                div.className = "complaintCard";
                fillComplaintCard(div, b);
                cardArea.appendChild(div);
            }
        }else if(btn.id === "cSortUnreviewed"){
            document.getElementById("cSortAll").checked = false;
            document.getElementById("cSortHigh").checked = false;
            document.getElementById("cSortLow").checked = false;

            const cardArea = document.getElementById("cardsArea");
            while(cardArea.firstChild){cardArea.removeChild(cardArea.firstChild)}

            const response = await fetch(baseUrl + `/complaints?priority=UNREVIEWED`, {method: "GET"});
            const body = await response.json();

            for(let b of body){
                const div = document.createElement("div");
                div.className = "complaintCard";
                fillComplaintCard(div, b);
                cardArea.appendChild(div);
            }

        }else if(btn.id === "cSortHigh"){
            document.getElementById("cSortAll").checked = false;
            document.getElementById("cSortUnreviewed").checked = false;
            document.getElementById("cSortLow").checked = false;

            const cardArea = document.getElementById("cardsArea");
            while(cardArea.firstChild){cardArea.removeChild(cardArea.firstChild)}

            const response = await fetch(baseUrl + `/complaints?priority=HIGH`, {method: "GET"});
            const body = await response.json();

            for(let b of body){
                const div = document.createElement("div");
                div.className = "complaintCard";
                fillComplaintCard(div, b);
                cardArea.appendChild(div);
            }

        }else if(btn.id === "cSortLow"){
            document.getElementById("cSortAll").checked = false;
            document.getElementById("cSortUnreviewed").checked = false;
            document.getElementById("cSortHigh").checked = false;

            const cardArea = document.getElementById("cardsArea");
            while(cardArea.firstChild){cardArea.removeChild(cardArea.firstChild)}

            const response = await fetch(baseUrl + `/complaints?priority=LOW`, {method: "GET"});
            const body = await response.json();

            for(let b of body){
                const div = document.createElement("div");
                div.className = "complaintCard";
                fillComplaintCard(div, b);
                cardArea.appendChild(div);
            }
        }
        
        
    });
    function fillComplaintCard(div, b){
        const title = document.createElement("h3");
            title.innerText = `${b.cType} ${b.id}`;
        
        const pLabel = document.createElement("label");
            pLabel.setAttribute("for", "pInput");
            pLabel.innerText = "Priority: ";
        const priority = document.createElement("select");
            priority.id = "priority" + b.id;
            priority.name = "pInput";
            const uOp = document.createElement("option");
                uOp.innerText = "UNREVIEWED";
            const hOp = document.createElement("option");
                hOp.innerText = "HIGH";
            const lOp = document.createElement("option");
                lOp.innerText = "LOW";
            const iOp = document.createElement("option");
                iOp.innerText = "IGNORED";
            priority.appendChild(uOp);
            priority.appendChild(hOp);
            priority.appendChild(lOp);
            priority.appendChild(iOp);
            priority.value = b.cPriority;
        
        const description = document.createElement("textArea");
            description.disabled = true;
            description.innerText = b.description;
        
        const mLabel = document.createElement("label");
            mLabel.setAttribute("for", "mIdInput");
            mLabel.innerText = "Meeting: ";
        const meetingId = document.createElement("input");
            meetingId.id = "meetingId" + b.id;
            meetingId.name = "mIdInput";
            meetingId.type = "number";
            meetingId.value = b.meetingId;
        
        const date = document.createElement("p");
        const dateString = new Date(b.date*1000);
            date.innerText = `Report Date: ${dateString.toISOString().replace(/T/, " ").replace(/.000Z/, "")}`;

        const edit = document.createElement("button");
            edit.className = "editComplaint";
            edit.id = b.id;
            edit.innerText = "Confirm";

        
        div.appendChild(title);
        div.appendChild(pLabel);
        div.appendChild(priority);
        div.appendChild(description);
        div.appendChild(mLabel);
        div.appendChild(meetingId);
        div.appendChild(date);
        div.appendChild(edit);
    }
    reviewC.addEventListener("click", async function(event){
        while(actionsArea.firstChild){
            actionsArea.removeChild(actionsArea.firstChild);
        }
        
        const response = await fetch(baseUrl + "/complaints", {
            method: 'GET'
        })
        const body = await response.json();

        const sortingDiv = document.createElement("div");
            sortingDiv.className = "cardSorting";
        const sortAll = document.createElement("input");
            sortAll.type = "checkbox";
            sortAll.name = "All";
            sortAll.id = "cSortAll";
            sortAll.checked = true;
        const labelA = document.createElement("label"); labelA.for = "All"; labelA.innerText = "All";
            
        
        const sortUnreviewed = document.createElement("input");
            sortUnreviewed.type = "checkbox";
            sortUnreviewed.name = "Unreviewed";
            sortUnreviewed.id = "cSortUnreviewed";
        const labelU = document.createElement("label"); labelU.for = "Unreviewed"; labelU.innerText = "Unreviewed";
        
        const sortHigh = document.createElement("input");
            sortHigh.type = "checkbox";
            sortHigh.name = "High";
            sortHigh.id = "cSortHigh";
        const labelH = document.createElement("label"); labelH.for = "High"; labelH.innerText = "High";
            
        
        const sortLow = document.createElement("input");
            sortLow.type= 'checkbox',
            sortLow.name= "Low"
            sortLow.id = "cSortLow";
        const labelL = document.createElement("label"); labelL.for = "Low"; labelL.innerText = "Low";
            

        sortingDiv.appendChild(sortAll);
        sortingDiv.appendChild(labelA);
        sortingDiv.appendChild(sortUnreviewed);
        sortingDiv.appendChild(labelU);
        sortingDiv.appendChild(sortHigh);
        sortingDiv.appendChild(labelH);
        sortingDiv.appendChild(sortLow);
        sortingDiv.appendChild(labelL);
        actionsArea.appendChild(sortingDiv);

        const cardsDiv = document.createElement("div");
        cardsDiv.id = "cardsArea";
        for(let b of body){
            const div = document.createElement("div");
            div.className = "complaintCard"
            fillComplaintCard(div, b);
            cardsDiv.appendChild(div);
        }
        actionsArea.appendChild(cardsDiv);
        
    });

    function fillMeetingCard(div, b){
        const title = document.createElement("h3");
        title.innerText = `Meeting ${b.id}`;
        const address = document.createElement("h5");
        address.innerText = `Address: ${b.address}`;
        const date = document.createElement("p");
        const dateString = new Date(b.date*1000);
        date.innerText = `Report Date: ${dateString.toISOString().replace(/T/, " ").replace(/.000Z/, "")}`;

        div.appendChild(title);
        div.appendChild(address);
        div.appendChild(date);
    }
    viewMeetings.addEventListener("click", async function(event){
        while(actionsArea.firstChild){
            actionsArea.removeChild(actionsArea.firstChild);
        }
        const response = await fetch(baseUrl + "/meetings", {
            method: 'GET'
        })
        const body = await response.json();

        for(let b of body){
            const div = document.createElement("div");
            fillMeetingCard(div, b);
            actionsArea.appendChild(div);
        }
    });

</script>
</html>
